# Story 16.1: Clerk-Native Team Invitation System

## Status
Planning

## Story
**As a** team leader  
**I want** to invite team members to join SingleBrief using Clerk's native invitation system  
**So that** all team members are properly onboarded to the platform and can participate in in-app intelligence conversations

## Acceptance Criteria
1. Team leaders can invite members via email using Clerk's invitation API
2. Invited users receive Clerk-generated invitation emails with signup links
3. New users complete signup process through Clerk authentication
4. Upon signup, users are automatically added to the correct organization/team
5. In-app chat interface replaces email-only response system
6. Email notifications are sent for queries with reply-to-chat threading
7. All team member management happens within the SingleBrief platform

## Tasks / Subtasks

### Task 1: Implement Clerk Invitation System (AC: 1, 2, 3, 4)
- [ ] **Research Clerk invitation API and implementation patterns**
  - [ ] Review Clerk documentation at https://clerk.com/docs/users/invitations
  - [ ] Understand invitation flow: create → send → accept → onboard
  - [ ] Identify required Clerk configuration and permissions
  - [ ] Plan integration with existing team management forms

- [ ] **Backend API integration for Clerk invitations**
  - [ ] Create invitation endpoint `/api/v1/team-management/clerk-invitations`
  - [ ] Integrate with Clerk's invitation API using organization context
  - [ ] Handle invitation status tracking and webhook events
  - [ ] Add invitation audit logging and error handling

- [ ] **Frontend invitation workflow updates**
  - [ ] Update team member form to use Clerk invitation instead of custom emails
  - [ ] Remove email-only response options from team management
  - [ ] Add invitation status display in team member list
  - [ ] Implement invitation resend functionality

- [ ] **Organization and team mapping**
  - [ ] Ensure invited users join correct Clerk organization
  - [ ] Map Clerk organization membership to team structure
  - [ ] Handle role assignment during invitation acceptance
  - [ ] Implement automatic team addition post-signup

### Task 2: In-App Chat Interface Development (AC: 5)
- [ ] **Replace email response system with chat interface**
  - [ ] Remove email-only response functionality from intelligence queries
  - [ ] Design and implement in-app chat components for team member responses
  - [ ] Create real-time messaging system for intelligence conversations
  - [ ] Add chat history and thread management

- [ ] **Chat interface for intelligence queries**
  - [ ] Update intelligence workflow to use in-app chat exclusively
  - [ ] Implement team member chat responses within query workflow
  - [ ] Add real-time notifications for new chat messages
  - [ ] Create chat persistence and history tracking

### Task 3: Email-to-Chat Integration System (AC: 6, 7)
- [ ] **Email notification system with chat threading**
  - [ ] Send email notifications for new intelligence queries to team members
  - [ ] Include unique reply-to addresses that map to specific chat threads
  - [ ] Implement email parsing system to extract responses
  - [ ] Add email-to-chat message threading and display

- [ ] **Chat thread management**
  - [ ] Design chat thread structure for intelligence conversations
  - [ ] Implement email response parsing and validation
  - [ ] Add email response integration to existing chat threads
  - [ ] Create unified chat view showing both in-app and email responses

### Task 4: Team Management Platform Migration (AC: 7)
- [ ] **Remove external email dependency**
  - [ ] Deprecate custom email invitation system
  - [ ] Update all team management workflows to platform-only
  - [ ] Remove email-only response options from user preferences
  - [ ] Ensure all communication happens through platform

- [ ] **Platform-centric user experience**
  - [ ] Update onboarding flow to emphasize platform usage
  - [ ] Create in-app tutorials for team members
  - [ ] Add platform engagement tracking and analytics
  - [ ] Implement user activity monitoring and encouragement

## Technical Requirements

### Clerk Integration
- **Invitation API**: Use Clerk's organization invitations
- **Authentication Flow**: Seamless post-invitation signup
- **Organization Management**: Proper team mapping and role assignment
- **Webhook Handling**: Track invitation status and user actions

### In-App Communication
- **Real-time Messaging**: WebSocket or SSE for live chat updates
- **Message Persistence**: Database storage for chat history
- **Thread Management**: Organize conversations by intelligence query
- **Notification System**: In-app and email notifications for new messages

### Email Integration
- **Reply-to Threading**: Unique email addresses mapping to chat threads
- **Email Parsing**: Extract content from email responses
- **Security**: Validate email sources and prevent spam
- **Fallback Handling**: Graceful degradation if email parsing fails

## User Experience Flow

### Team Leader Workflow
1. Navigate to Team Management → Add Member
2. Fill member details including profile information
3. Click "Send Clerk Invitation" (replaces custom email option)
4. System creates Clerk invitation and sends via Clerk's email system
5. Track invitation status in team member list

### Team Member Workflow
1. Receive Clerk invitation email with branded signup link
2. Complete Clerk signup process (Google Auth or email/password)
3. Automatic redirect to SingleBrief with organization membership
4. Complete profile setup with role, bio, expertise tags
5. Participate in intelligence queries via in-app chat

### Intelligence Query Workflow
1. Team leader asks intelligence question
2. System selects relevant team members based on expertise/role
3. Send in-app notifications + email notifications to selected members
4. Team members respond via in-app chat interface
5. Email responses (if any) automatically threaded into chat
6. AI synthesizes responses and provides intelligence report

## Dev Notes

### Current Implementation Status
Based on existing code review, current state includes:
- Team member form with communication platform fields (✅ Implemented)
- Custom email invitation system (❌ Needs replacement with Clerk)
- Profile management with Clerk integration (✅ Implemented)
- Intelligence workflow with team selection (✅ Implemented)

### Required Changes
1. **Replace custom invitation with Clerk API calls**
2. **Remove email-only response options from all forms**
3. **Implement in-app chat components for intelligence responses**
4. **Add email-to-chat threading system**
5. **Update all team management workflows to be platform-centric**

### Files to Modify
- `app/team-management/page.tsx` - Replace invitation API calls
- `src/components/team-management/team-member-form.tsx` - Remove email-only options
- `app/query/page.tsx` - Update to use in-app chat instead of email simulation
- Backend: New endpoints for Clerk invitation integration
- Backend: Email-to-chat threading system implementation

### Clerk Configuration Required
- Organization invitation settings and branding
- Webhook configuration for invitation tracking
- Email template customization for branded invitations
- Organization role and permission setup

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-11 | 1.0 | Initial story creation for Clerk-native invitations | John (PM Agent) |